<!DOCTYPE html>
<html>
	<head>
		<base href="../../" />
		<meta charset="utf-8" />

		<script src="_ext/d3.v3.min.js"></script>
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/sha1.js"></script>
		<script src="_ext/seedrandom-min.js"></script>
		<script type="text/javascript" src="_ext/crossfilter.min.js"></script>
		<script type="text/javascript" src="_ext/dc.min.js"></script>

		<link rel="stylesheet" href="_ext/dc.css" />


		<script src="js/jlg_commons.js"></script>
		<script src="js/thread.js"></script>
		<script src="js/stc_mp/main.js"></script>
		<script src="js/stc_mp/Utils.js"></script>
		<script src="js/stc_mp/System.js"></script>
		<script src="js/stc_mp/Actor.js"></script>
		<script src="js/stc_mp/Node.js"></script>
		<script src="js/stc_mp/CycleAmount.js"></script>


		<script src="js/widget_table.js"></script>
		<link rel="stylesheet" href="js/theme/default/widget_table.css" />

		<style>
html, body {
	width: 100%;
	height: 100%;
	margin: 0px;
	padding: 0px;
}

#param {
	float: left;
	width: 300px;
	height: 600px;
	overflow: hidden;

	background-color: #E6F2FF;
}

svg {
	margin-top: 10px;
	border: 1px solid black;
}

table {
	width: 100%;
}

table th, table td {
	vertical-align: middle;
	text-align: center;
	font-size: 14px;
}

th {
	width: 100px;
	font-weight: 400;
}

input, select, table button {
	width: 100%;
	font-size: 14px;
	font-weight: 400;

	box-sizing: border-box;
}

#stat * {
	font-size: 12px;
}

#stat table {
	width: 100%;
	white-space: nowrap;
}

#stat th {
	text-align: right;
	width: 0px;
}

#stat td {
	text-align: left;
}

.menu {
	width: 100%;
	height: 30px;

	text-align: center;
	font-size: 0;

	border-bottom: 1px solid black;
}

.menu .button {
	display: inline-block;
	vertical-align: middle;
	width: 66px;
	height: 100%;

	font-size: 18px;
	line-height: 28px;

	cursor: pointer;
	background-color: #FBFDFF
}

.menu .button:hover {
	background-color: #CECECE;
}

.menu .disabled {
	color: #DDDDDD;
	cursor: default;
}

.menu .disabled:hover {
	background-color: #FBFDFF;
}

.menu .selected {
	background-color: transparent;
}

.body {
	width: 100%;
}

.body > div {
	width: 100%;
	height: 100%;
}

#node_qty, #actor_qty {
	width: 38px;
	height: 24px;
	text-align: right;
}

.actor rect, .node rect {
	stroke: transparent;
	fill: transparent;
	stroke-width: 0;
}

.selected rect {
	fill: #EEEEEE;
}

.link {
	fill: none;
	stroke-width: 1;
}

.clickable {
	cursor: pointer;
}

#view {
	overflow: auto;
	height: 230px;
}

#view table {
	border-collapse: collapse;
}

#view table td, #view table th {
	font-size: 12px;
}

#view tr.actor:hover {
	background-color: #CECECE;
}

#view tr.selected {
	background-color: #FFC68C;
}

#view th {
	font-weight: bold;
}

#view .stc, #view .nodes, #view .volume {
	text-align: right;
}

#chart_buttons {
	display: none;
}

#chart_buttons table {
	width: 950px;
}

#chart_buttons th {
	width: 50px;
	font-weight: bold;
	text-align: right;
}

#chart_buttons td {
	text-align: left;
}

#chart_buttons button {
	width: auto;
}

#offers {
	float: left;
}

#demands {
	float: right;
}

#offers .gb_qty, #offers .price_per_gb, #demands .price_per_stc, #demands .stc_qty {
	color: #AAAAAA;
}

#frame .title {
	text-align: center;
	font-size: 20px;
	font-weight: bold;
}

#frame th {
	width: 75px;
	font-weight: 400;
}

#frame #mp {
	height: 270px;
	overflow: auto;
}
		</style>
	</head>

	<body>
		<div>
			<div id="param">
				<div class="menu">
					<div class="button" data-body="settings">Settings</div>
					<div class="button disabled" data-body="actor">Actor</div>
					<div class="button disabled" data-body="node">Node</div>
				</div>
				<div class="body">
					<div class="param_body actor">
						<table>
							<tr>
								<th>Name</th>
								<td class="name"></td>
							</tr>
							<tr>
								<th>STC</th>
								<td class="amount"></td>
							</tr>
							<tr>
								<th>Mental</th>
								<td class="mental"></td>
							</tr>
							<tr>
								<th>Wealth</th>
								<td class="wealth"></td>
							</tr>
						</table>
					</div>

					<div class="param_body node">
						<table>
							<tr>
								<th>Name</th>
								<td class="name"></td>
							</tr>
							<tr>
								<th>Owner</th>
								<td class="owner"></td>
							</tr>
						</table>
						<button id="rm_node" disabled="disabled">Remove Node</button>
					</div>

					<div class="param_body settings">
						<table>
							<tr>
								<th>Animation</th>
								<td>
									<select id="animation">
										<option value="on" selected>On</option>
										<option value="off">Off</option>
									</select>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<hr/>
				<button id="start">Start</button>
				<button id="stop">Stop</button>
				<button id="pause_resume">Pause</button><br/>
				<button id="next_cycle" disabled="disabled">Next cycle</button>
				<button id="do_cycle" disabled="disabled">Do cycle</button><br/>
				<button id="add_actor" disabled="disabled">Add actor</button><input type="number" id="actor_qty" min="1" max="99" value="1" disabled="disabled" />
				<button id="add_node" disabled="disabled">Add Node</button><input type="number" id="node_qty" min="1" max="99" value="1" disabled="disabled" /><br/>
				<button id="debug">Debug</button><br/>
				<hr/>
				<button id="scenario1">Scenario 1</button>
				<button id="scenario2">Scenario 2</button><br/>
				<hr/>

				<div id="stat">
					<table>
						<tr>
							<th>Actors:</th>
							<td class="actors">0</td>
							<th>Nodes:</th>
							<td class="nodes">0</td>
						</tr>
						<tr>
							<th>Providers:</th>
							<td class="providers">0</td>
							<th>Capacity:</th>
							<td class="capacity">0 GB</td>
						</tr>
						<tr>
							<th>Consumers:</th>
							<td class="consumers">0</td>
							<th>TOTAL STC:</th>
							<td class="stc_total" data-value="0">0 STC</td>
						</tr>
						<tr>
							<th>1 STC:</th>
							<td class="stc_gb">0.00 GB</td>
							<th>1 STC:</th>
							<td class="stc_price">0.00 $</td>
						</tr>
					</table>
				</div>
				<hr/>

				<div id="view">
					<table class="actors">
						<tr>
							<th>Actor</td>
							<th class="stc">STC</td>
							<th class="volume">Volume</td>
							<th class="nodes">Nodes</td>
						</tr>
						<tr class="total">
							<th>Total</td>
							<th class="stc">0</td>
							<th class="volume">0 GB</td>
							<th class="nodes">0</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="frame">
				<div id="mp">
					<div id="offers"><div class="title">Offers</div></div>
					<div id="demands"><div class="title">Demands</div></div>
				</div>
			</div>
			<div id="chart_buttons">
				<table>
					<tr>
						<th>System:</th>
						<td class="system">
							<button class="change_chart" data-value="gb_per_stc">GB/STC</button>
							<button class="change_chart" data-value="price_per_stc">$/STC</button>
							<button class="change_chart" data-value="price_per_gb">$/GB</button>
							<button class="change_chart" data-value="total_stc">Total STC</button>
							<button class="change_chart" data-value="competition">Competition</button>
							<br/>
							<button class="change_chart" data-value="actors" data-stack="providers consumers">Actors</button>
							<button class="change_chart" data-value="nodes">Nodes</button>
							<button class="change_chart" data-value="capacity">Capacity</button>
							<button class="change_chart" data-value="performed_deal_nbr">Deal amount</button>
							<button class="change_chart" data-value="usage" data-unit="%">Usage</button>
							<br/>
							<button class="change_chart" data-value="attractivity_provider_rate">PAR</button>
							<button class="change_chart" data-value="attractivity_consumer_rate">CAR</button>
						</td>
						<th>Actor:</th>
						<td class="actor">
							<button class="change_chart_actor" data-value="actor_stc" disabled="disabled">STC</button>
							<button class="change_chart_actor" data-value="actor_nodes" disabled="disabled">Nodes</button>
							<button class="change_chart_actor" data-value="actor_volume" disabled="disabled">Volume</button>
							<button class="change_chart_actor" data-value="actor_cumulated_mined_stc" disabled="disabled">Mined</button>
							<br/>
							<button class="change_chart_actor" data-value="actor_price_amount" disabled="disabled">$</button>
							<button class="change_chart_actor" data-value="actor_price_earned_amount" disabled="disabled">$ earned</button>
							<button class="change_chart_actor" data-value="actor_price_capital" data-stack="actor_price_earned_amount actor_price_amount" disabled="disabled">$ capital</button>
							<button class="change_chart_actor" data-value="actor_effectiveness" disabled="disabled">Evectiveness</button>
						</td>
					</tr>
				</table>
			</div>
			<div id="chart"></div>
		</div>

		<script>
var context = {
	providerIndex: 0,
	userIndex: 0,
	nodeIndex: 0,
	providers: [],
	consumers: [],
	nodes: [],
	cycle_id: 0
}

// CHART STUFF
var ndx;
var xDim;
var group;
var lineChart;
var dataset = [];
var actor_dataset_aa = {};
var chart_group_selector = 'system';
var current_chart_title = 'GB/STC';

var group_stack = [];

var button_tips = {
	gb_per_stc: 'Value of 1 STC in GB.',
	price_per_stc: 'Exchange rate of 1 STC in $.',
	price_per_gb: 'Exchange rate of 1 GB in $.',
	total_stc: 'Total amount of STC in the system.',
	actors: 'Number of actors in the system.',
	nodes: 'Number of nodes in the system.',
	capacity: 'Total capacity, in GB, of the system.',
	performed_deal_nbr: 'Number of deals done during a cycle.',
	usage: '',
	competition: '',

	attractivity_provider_rate: 'Provider Attractivity Rate',
	attractivity_consumer_rate: 'Consumer Attractivity Rate',

	actor_stc: 'STC amount for the given actor.',
	actor_price_amount: '$ amount of the STC amount for the given actor.',
	actor_nodes: 'Number of nodes for the given actor.',
	actor_volume: 'Number of GB for the given actor.',
	actor_cumulated_mined_stc: 'Number of STC mined by the given actor.',
	actor_price_earned_amount: '$ earned from transactions.',
	actor_price_capital: 'Total $ (earned from transaction + current STC amount).',
	actor_effectiveness: ''
};

var legends = {
	providers: 'Providers',
	consumers: 'Consumers',
	actor_price_earned_amount: '$ earned',
	actor_price_amount: '$'
};

function get_initial_actor_dataset() {
	return [{
		cycle: sys.cycle_id,
		actor_stc: 0,
		actor_nodes: 0,
		actor_volume: 0,
		actor_price_amount: 0,
		actor_cumulated_mined_stc: 0,
		actor_price_earned_amount: 0,
		actor_effectiveness: 1
	}];
}

function actor_push_data(actor, gb_per_stc) {
	var price_amount = actor.amount * sys.price_per_stc;

	actor_dataset_aa[actor.name].push({
		cycle: sys.cycle_id,
		actor_stc: actor.amount,
		actor_nodes: actor.nodes.length,
		actor_volume: jlg.round(actor.amount * gb_per_stc),
		actor_price_amount: price_amount,
		actor_cumulated_mined_stc: actor.mined_amount,
		actor_price_earned_amount: actor.price_earned_amount,
		actor_effectiveness: (actor.price_earned_amount + price_amount) / (actor.mined_amount * sys.price_per_stc)
	});
}

function set_button_title(el) {
	el.attr('title', button_tips[el.attr('data-value')]);
}
// END CHART STUFF

$(document).ready(function() {
	$('.change_chart').each(function() {
		set_button_title($(this));
	});
	$('.change_chart_actor').each(function() {
		set_button_title($(this));
	});

	$('.param_body').hide();
	$('.menu [data-body=settings]').click();
	set_screen_size();

	start();
});

var onObjectSelected = function(object) {
	console.log(object);
	if (object instanceof stc.Actor) {
		$('#add_node').attr('disabled', false);
		$('#node_qty').attr('disabled', false);
		$('#chart_buttons .actor button').attr('disabled', false);

		// Disable nodes buttons
		$('#rm_node').attr('disabled', false);

		var actorMenu = $('.param_body.actor');
		actorMenu.find('.name').html(object.name);
		actorMenu.find('.amount').html(object.amount);
		actorMenu.find('.mental').html(jlg.round(object.profile.mental_rate));
		actorMenu.find('.wealth').html(jlg.round(object.profile.wealth));
		$('.menu [data-body=actor]').click();

		update_chart('actor');
		refresh_chart();
	}

	if (object instanceof stc.Node) {
		$('#rm_node').attr('disabled', false);

		var nodeMenu = $('.param_body.node');
		nodeMenu.find('.name').html(object.name);
		nodeMenu.find('.owner').html(object.owner.name);

		var actorMenu = $('.param_body.actor');
		actorMenu.find('.name').html(object.owner.name);
		actorMenu.find('.amount').html(object.owner.amount);
		actorMenu.find('.mental').html(jlg.round(object.owner.profile.mental_rate));
		actorMenu.find('.wealth').html(jlg.round(object.owner.profile.wealth));

		$('.menu [data-body=node]').click();

		// Disable actors buttons
		$('#add_node').attr('disabled', true);
		$('#node_qty').attr('disabled', true);
		$('#chart_buttons .actor button').attr('disabled', true);

		update_chart('system');
		refresh_chart();
	}
};

var onObjectDeselected = function(object) {
	$('#add_node').attr('disabled', true);
	$('#node_qty').attr('disabled', true);
	$('#chart_buttons .actor button').attr('disabled', true);
	$('#rm_node').attr('disabled', true);

	var actorMenu = $('.param_body.actor');
	actorMenu.find('.name').html('');
	actorMenu.find('.amount').html('');
	actorMenu.find('.wealth').html('');

	var nodeMenu = $('.param_body.node');
	nodeMenu.find('.name').html('');
	nodeMenu.find('.owner').html('');

	update_chart('system');
	refresh_chart();
};

function update_chart(selector) {
	if (chart_group_selector != selector) {
		chart_group_selector = selector;
		if (selector == 'system') {
			group = xDim.group().reduceSum(jlg.accessor('stc'));
		} else if (selector == 'actor') {
			group = xDim.group().reduceSum(jlg.accessor('actor_stc'));
		}
		current_chart_title = 'STC';
	}
}

var sys = null;

function start() {
	reset_stats();
	//reset_chart();
	Math.seedrandom('Hello');

	context = {
		providerIndex: 0,
		userIndex: 0,
		nodeIndex: 0,
		providers: [],
		consumers: [],
		nodes: [],
		cycle_id: 0
	}

	$('.menu [data-body=actor]').removeClass('disabled');
	$('.menu [data-body=node]').removeClass('disabled');
	$('#add_actor').attr('disabled', null);
	$('#actor_qty').attr('disabled', null);
	$('#next_cycle').attr('disabled', null);
	$('#do_cycle').attr('disabled', null);
	$('#chart_buttons').css('display', 'block');
	$('#pause_resume').attr('data-paused', 'false');
	$('#pause_resume').attr('disabled', null);

	d3.select('#frame').select('svg').remove();
	var svg = d3.select('#frame').append('svg');

	set_screen_size();
	sys = new stc.System(svg, actor_dataset_aa, dataset, '#offers', '#demands', {
		sideView: '#view',
		actorsView: '.param_body.actor',
		nodesView: '.param_body.node'
	});

	sys.repaintSideView();

	refresh_options();
	init_graph();
}

function set_screen_size() {
	var size = $('#screen_size').val();
	var svg = d3.select('#frame').select('svg');
	svg.attr('width', 950)
		.attr('height', 25);
	$('#param').css('height', 600);
}

function refresh_options() {
	sys.options.report_elem = $('#stat').get(0);
	sys.options.callback.onObjectSelected = onObjectSelected;
	sys.options.callback.onObjectDeselected = onObjectDeselected;
	sys.options.nodeCapacity = 50;

	set_animation_durations();
}

$('#animation').change(set_animation_durations);

function set_animation_durations() {
	if (!sys) {
		return;
	}
	switch($('#animation').val()) {
		case 'on':
			sys.options.duration = {
				addActor: 1000,
				addNode: 1000,
				ca: {
					show: 500,
					split: 1000
				}
			};
			sys.offers_table.options.duration = {
				repaint: 300,
				move: 2000
			};
			sys.demands_table.options.duration = {
				repaint: 300,
				move: 2000
			};
			break;
		case 'off':
			sys.options.duration = {
				addActor: 0,
				addNode: 0,
				ca: {
					show: 0,
					split: 0
				}
			};
			sys.offers_table.options.duration = {
				repaint: 0,
				move: 0
			};
			sys.demands_table.options.duration = {
				repaint: 0,
				move: 0
			};
			break;
	}
}


$('#start').click(function() {
	start();
});

$('#pause_resume').click(function() {
	if ($(this).attr('data-paused') == 'false') {
		sys.pause.isRequested = true;
		$(this).html('Resume');
		$(this).attr('data-paused', 'true');
	}else {
		sys.pause.isRequested = false;
		$(this).html('Pause');
		$(this).attr('data-paused', 'false');
		sys.pause.thread.next();
	}
});

$('#add_actor').click(function() {
	var actor_qty = $('#actor_qty').val();

	refresh_options();

	var thread = new Thread('main');
	thread.execute(function() {
		$('#add_actor').attr('disabled', 'disabled');
	});

	for (var i = 0; i < actor_qty; i++) {
		sys.addActor(thread, new stc.Actor('Provider_' + context.providerIndex));
		context.providerIndex++;
	}

	thread.execute(function() {
		$('#add_actor').attr('disabled', null);
	});

	thread.finish();
	thread.start();
});

$('#add_node').click(function() {
	var node_qty = $('#node_qty').val();

	refresh_options();

	var thread = new Thread('main');
	thread.execute(function() {
		$('#add_node').attr('disabled', 'disabled');
	});

	for (var i = 0; i < node_qty; i++) {
		sys.addNode(thread, new stc.Node('Node_' + context.nodeIndex, sys.selectedObject));
		context.nodeIndex++;
	}

	thread.execute(function() {
		$('#add_node').attr('disabled', null);
	});

	thread.finish();
	thread.start();
});

$('#rm_node').click(function() {
	refresh_options();
	var selectedNode = sys.selectedObject;

	var thread = new Thread('main');
	sys.unselectObject(thread, sys.selectedObject);
	sys.removeNode(thread, selectedNode);

	thread.finish();
	thread.start();
});

$('#next_cycle').click(function() {
	refresh_options();

	var thread = new Thread('main');
	stc.Utils.disableButton(thread, '#next_cycle');
	sys.nextCycle(thread);
	stc.Utils.enableButton(thread, '#next_cycle');

	thread.finish();
	thread.start();
});

$('#do_cycle').click(function() {
	refresh_options();
	var scenario = new stc.Scenario(sys, context);
	stc.Utils.disableButton(scenario.thread, '#do_cycle');
	scenario.doCycle();
	stc.Utils.enableButton(scenario.thread, '#do_cycle');
	scenario.start();
});

$('#stop').click(function() {
	window.location.reload();
});

$('#scenario1').click(s1);
$('#scenario2').click(s2);

function s1() {
	$('#animation').val('on');

	start();
	sys.totalSTC = 0;
	sys.computeAttractivity();

	var thread = new Thread('main');
	//thread.setDebug('#debug');

	var providers = [];
	var provider_qty = 3;
	for(var i = 0; i < provider_qty; i++) {
		var provider = new stc.Actor('Provider_' + context.providerIndex);
		sys.addActor(thread, provider);
		providers.push(provider);
		context.providerIndex++;

		sys.addNode(thread, new stc.Node(provider));
		context.nodeIndex++;
	}

	sys.nextCycle(thread);

	var consumer_qty = 3;
	for(var i = 0; i < consumer_qty; i++) {
		var consumer = new stc.Actor('Consumer_' + context.userIndex);
		sys.addActor(thread, consumer);
		context.userIndex++;
		sys.publishDemand(thread, consumer, 50, 0.7 + (i / 10));
	}

	for(var i = 0; i < provider_qty; i++) {
		sys.publishOffer(thread, providers[i], 20, 1.2 + (i / 10));
	}

	sys.processDeals(thread);
	sys.nextCycle(thread);

	thread.finish();
	thread.start();
}

function s2() {
	$('#animation').val('off');
	start();

	var thread = new Thread('main');
	sys.runCycle(thread, 5);

	thread.finish();
	thread.start();
}

$('.menu .button').click(function() {
	if ($(this).hasClass('disabled')) {
		return;
	}

	var body = $(this).attr('data-body');
	$('.param_body').hide();
	$('.menu .button').removeClass('selected');

	$(this).addClass('selected');
	$('.body .' + body).show();
});

function reset_stats() {
	$('#stat td').html(0);
	$('#stat .capacity').html('0 GB');
	$('#stat .stc_gb').html('0.00 GB');
	$('#stat .stc_price').html('0.00 $');
	$('#stat .stc_total').html('0 STC');
};

$('#stat').get(0).addEventListener("system_stat", function(e) {
	var stats = e.detail;
	var el = $(this);


	el.find('.actors').html(sys.actors.length);
	el.find('.providers').html(sys.providers.length);
	el.find('.consumers').html(sys.consumers.length);
	el.find('.actors').html(sys.actors.length);
	el.find('.nodes').html(sys.nodes.length);
	var capacity = sys.nodes.length * sys.options.nodeCapacity;
	el.find('.capacity').html(capacity + ' GB');
	el.find('.stc_total').html(sys.totalSTC + ' STC');
	el.find('.stc_price').html(jlg.round(sys.price_per_stc) + ' $')
	el.find('.stc_gb').html(jlg.round(sys.gb_per_stc) + ' GB')
		.attr('data-value', jlg.round(sys.gb_per_stc));

	switch (stats.action) {
		case 'add_actor':
			actor_dataset_aa[stats.actor.name] = get_initial_actor_dataset();
			break;
		case 'add_node':
			break;
		case 'remove_node':
			break;
		case 'next_cycle':
			update_dataset();
			refresh_chart();
			break;
	}
});

function update_dataset() {
	var gb_per_stc = 0;
	if (sys.nodes.length > 0) {
		gb_per_stc = (sys.nodes.length * sys.options.nodeCapacity) / sys.totalSTC;
	}

	var used = 0;
	for (var i = 0; i < sys.consumers.length; i++) {
		used += sys.consumers[i].amount;
	}

	dataset.push({
		cycle: sys.cycle_id,
		gb_per_stc: gb_per_stc,
		price_per_stc: sys.price_per_stc,
		price_per_gb: sys.price_per_gb,
		total_stc: sys.totalSTC,
		nodes: sys.nodes.length,
		actors: sys.actors.length,
		consumers: sys.consumers.length,
		providers: sys.providers.length,
		capacity: sys.nodes.length * sys.options.nodeCapacity,
		performed_deal_nbr: sys.performed_deal_nbr,
		usage: used * 100 / sys.totalSTC,
		competition: sys.competition_price_per_gb,
		attractivity_provider_rate: sys.attractivity.provider_rate,
		attractivity_consumer_rate: sys.attractivity.consumer_rate
	});

	for (var i = 0; i < sys.actors.length; i++) {
		var actor = sys.actors[i];
		actor_push_data(actor, gb_per_stc);
	}
}

function refresh_chart() {
	ndx.remove();
	var prefix = '';
	if (chart_group_selector == 'system') {
		ndx.add(dataset);
		lineChart.group(group, current_chart_title);
	} else {
		ndx.add(actor_dataset_aa[sys.selectedObject.name]);
		prefix = sys.selectedObject.name + ' ';
		lineChart.group(group, prefix + current_chart_title);
	}

	for (var i = 0; i < group_stack.length; i++) {
		var g = group_stack[i];
		lineChart.stack(g.group, prefix + g.label);
	}

	lineChart.x(d3.scale.linear().domain([0,sys.cycle_id]))
		.elasticX(true);
	dc.redrawAll();
}

function reset_chart() {
	dataset.length = 0;
	dataset.push({
		cycle: 0,
		gb_per_stc: sys.gb_per_stc,
		price_per_stc: sys.price_per_stc,
		price_per_gb: sys.price_per_gb,
		total_stc: sys.totalSTC,
		nodes: 0,
		actors: 0,
		providers: 0,
		consumers: 0,
		capacity: 0,
		performed_deal_nbr: 0,
		usage: 0,
		competition: sys.competition_price_per_gb,
		attractivity_provider_rate: 1,
		attractivity_consumer_rate: 1
	});
	actor_dataset_aa = {};
	current_chart_title = 'GB/STC';
	chart_group_selector == 'system'
	if (sys) {
		group = xDim.group().reduceSum(jlg.accessor('gb_per_stc'));
		refresh_chart();
	}
}



function init_graph() {
	ndx = crossfilter();
	xDim = ndx.dimension(function(d) {return d.cycle;});
	group = xDim.group().reduceSum(function(d) {return d.gb_per_stc;});
	lineChart = dc.lineChart("#chart")
		.renderArea(true)
		.width(950).height(190)
		.dimension(xDim)
		.group(group, 'GB/STC')
		.legend(dc.legend().x(40).y(20).itemHeight(10).gap(5))
		.x(d3.scale.linear().domain([0,sys.cycle_id]))
		.elasticY(true)
		.brushOn(false);
	dc.renderAll();
	reset_chart();
}

$('.change_chart').click(function() {
	if ($(this).attr('data-stack')) {
		set_stack_chart($(this));
	} else {
		set_chart($(this));
	}
	chart_group_selector = 'system';
	refresh_chart();
});

$('.change_chart_actor').click(function() {
	if ($(this).attr('data-stack')) {
		set_stack_chart($(this));
	} else {
		set_chart($(this));
	}
	chart_group_selector = 'actor'
	refresh_chart();
});

function set_chart(el) {
	clean_stack(1);

	current_chart_title = el.html();
	var val_to_show = el.attr('data-value');
	group = xDim.group().reduceSum(jlg.accessor(val_to_show));

	var unit = el.attr('data-unit') || '';
	lineChart.yAxis().tickFormat(function(v) {return v + unit;})
}

function set_stack_chart(el) {
	current_chart_title = el.html();
	var values = el.attr('data-stack').split(' ');

	clean_stack(values.length);

	var val_to_show = values[0];
	group = xDim.group().reduceSum(jlg.accessor(val_to_show));
	current_chart_title = legends[values[0]];

	var parent = el.parent();
	for (var i = 1; i < values.length; i++) {
		var g = xDim.group().reduceSum(jlg.accessor(values[i]));
		var label = legends[values[i]];
		group_stack.push({ label: label, group: g });
	}

	var unit = el.attr('data-unit') || '';
	lineChart.yAxis().tickFormat(function(v) {return v + unit;})
}

function clean_stack(nbr) {
	group_stack = [];
	var my_dataset = [];
	for (var i = 0; i < nbr; i++) {
		my_dataset.push(i);
	}
	//console.log(lineChart.data());
	var svg = d3.select('#chart').select('svg');
	var stack = svg.select('g.chart-body').selectAll('g.stack-list').selectAll('g.stack');
	stack.data(my_dataset)
		.exit().remove();
	svg.select('g.chart-body').selectAll('g.dc-tooltip-list').selectAll('g.dc-tooltip').data(my_dataset)
		.exit().remove();
}


// For crossfilter debuging.
function print_filter(filter){
	var f=eval(filter);
	if (typeof(f.length) != "undefined") {}else{}
	if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
	if (typeof(f.dimension) != "undefined")
	{f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
	console.log(filter+"("+f.length+") = "+JSON.stringify
	(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
}
		</script>
	</body>
</html>