<!DOCTYPE html>
<html>
	<head>
		<base href="../../" />
		<meta charset="utf-8" />

		<script src="_ext/d3.v3.min.js"></script>
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/sha1.js"></script>
		<script src="_ext/seedrandom-min.js"></script>
		<script src="js/jlg_commons.js"></script>
		<script src="js/thread.js"></script>
		<script src="js/stc/main.js"></script>
		<script src="js/stc/Utils.js"></script>
		<script src="js/stc/System.js"></script>
		<script src="js/stc/Actor.js"></script>
		<script src="js/stc/Node.js"></script>
		<script src="js/stc/CycleAmount.js"></script>
		<script src="js/stc/Scenario.js"></script>

		<style>
html, body {
	width: 100%;
	height: 100%;
	margin: 0px;
	padding: 0px;
}

#param {
	float: left;
	width: 250px;
	height: 600px;
	overflow: auto;

	background-color: #E6F2FF;
}

svg {
	border: 1px solid black;
}

table {
	width: 100%;
}

table th, table td {
	vertical-align: middle;
	text-align: center;
	font-size: 14px;
}

th {
	width: 100px;
	font-weight: 400;
}

input, select, table button {
	width: 100%;
	font-size: 14px;
	font-weight: 400;

	box-sizing: border-box;
}

#stat * {
	font-size: 12px;
}

#stat th {
	text-align: right;
}

#stat td {
	width: 25px;
	text-align: left;
}

.menu {
	width: 100%;
	height: 30px;

	text-align: center;
	font-size: 0;

	border-bottom: 1px solid black;
}

.menu .button {
	display: inline-block;
	vertical-align: middle;
	width: 66px;
	height: 100%;

	font-size: 18px;
	line-height: 28px;

	cursor: pointer;
	background-color: #FBFDFF
}

.menu .button:hover {
	background-color: #CECECE;
}

.menu .disabled {
	color: #DDDDDD;
	cursor: default;
}

.menu .disabled:hover {
	background-color: #FBFDFF;
}

.menu .selected {
	background-color: transparent;
}

.body {
	width: 100%;
}

.body > div {
	width: 100%;
	height: 100%;
}

#node_qty, #actor_qty {
	width: 38px;
	height: 24px;
	text-align: right;
}

.actor rect, .node rect {
	stroke: transparent;
	fill: transparent;
	stroke-width: 0;
}

.selected rect {
	fill: #EEEEEE;
}

.link {
	fill: none;
	stroke-width: 1;
}

.clickable {
	cursor: pointer;
}

#view table {
	border-collapse: collapse;
}

#view tr.selected {
	background-color: #FFC68C;
}

#view th {
	font-weight: bold;
}

#view .stc, #view .nodes {
	text-align: right;
}
		</style>
	</head>

	<body>
		<div>
			<div id="param">
				<div class="menu">
					<div class="button" data-body="settings">Settings</div>
					<div class="button disabled" data-body="actor">Actor</div>
					<div class="button disabled" data-body="node">Node</div>
				</div>
				<div class="body">
					<div class="param_body actor">
						<table>
							<tr>
								<th>Name</th>
								<td class="name"></td>
							</tr>
							<tr>
								<th>STC</th>
								<td class="amount"></td>
							</tr>
						</table>
					</div>

					<div class="param_body node">
						<table>
							<tr>
								<th>Name</th>
								<td class="name"></td>
							</tr>
							<tr>
								<th>Owner</th>
								<td class="owner"></td>
							</tr>
						</table>
						<button id="rm_node" disabled="disabled">Remove Node</button>
					</div>

					<div class="param_body settings">
						<table>
							<tr>
								<th>Screen size</th>
								<td>
									<select id="screen_size">
										<option value="debug">Debug</option>
										<option value="fullscreen" selected>Full Screen</option>
									</select>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<hr/>
				<button id="start">Start</button>
				<button id="stop">Stop</button>
				<button id="next_cycle" disabled="disabled">Next cycle</button><br/>
				<button id="add_actor" disabled="disabled">Add actor</button><input type="number" id="actor_qty" min="1" max="99" value="1" disabled="disabled" />
				<button id="add_node" disabled="disabled">Add Node</button><input type="number" id="node_qty" min="1" max="99" value="1" disabled="disabled" /><br/>
				<button id="debug">Debug</button><br/>
				<hr/>
				<button id="scenario1">Scenario 1</button>
				<button id="scenario2">Scenario 2</button><br/>
				<hr/>

				<div id="stat">
					<table>
						<tr>
							<th>Actors:</th>
							<td class="actors">0</td>
						</tr>
						<tr>
							<th>Nodes:</th>
							<td class="nodes">0</td>
						</tr>
						<tr>
							<th>Capacity:</th>
							<td class="capacity">0 GB</td>
						</tr>
						<tr>
							<th>1 STC:</th>
							<td class="stc_gb">0.00 GB</td>
						</tr>
					</table>
				</div>

				<div id="view">
					<table class="actors">
						<tr>
							<th>Actor</td>
							<th class="stc">STC</td>
							<th class="nodes">Nodes</td>
						</tr>
						<tr class="total">
							<th>Total</td>
							<th class="stc">0</td>
							<th class="nodes">0</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="frame"></div>
		</div>

		<script>
var actorIndex = 0;
var actorCounter = 0;
var nodeIndex = 0;
var nodeCounter = 0;
var seq = new jlg.Sequence();


var onObjectSelected = function(object) {
	console.log(object);
	if (object instanceof stc.Actor) {
		$('#add_node').attr('disabled', false);
		$('#node_qty').attr('disabled', false);

		var actorMenu = $('.param_body.actor');
		actorMenu.find('.name').html(object.name);
		actorMenu.find('.amount').html(object.amount);
		$('.menu [data-body=actor]').click();
	}

	if (object instanceof stc.Node) {
		$('#rm_node').attr('disabled', false);

		var nodeMenu = $('.param_body.node');
		nodeMenu.find('.name').html(object.name);
		nodeMenu.find('.owner').html(object.owner.name);
		$('.menu [data-body=node]').click();
	}
};

var onObjectDeselected = function(object) {
	if (object instanceof stc.Actor) {
		$('#add_node').attr('disabled', true);
		$('#node_qty').attr('disabled', true);

		var actorMenu = $('.param_body.actor');
		actorMenu.find('.name').html('');
		actorMenu.find('.amount').html('');
	}

	if (object instanceof stc.Node) {
		$('#rm_node').attr('disabled', true);

		var nodeMenu = $('.param_body.node');
		nodeMenu.find('.name').html('');
		nodeMenu.find('.owner').html('');
	}
};

var sys = null;

function init() {
	Math.seedrandom('Hello');

	actorIndex = 0;
	actorCounter = 0;
	nodeIndex = 0;
	nodeCounter = 0;

	$('.menu [data-body=actor]').removeClass('disabled');
	$('.menu [data-body=node]').removeClass('disabled');
	$('#add_actor').attr('disabled', null);
	$('#actor_qty').attr('disabled', null);
	$('#next_cycle').attr('disabled', null);

	d3.select('#frame').select('svg').remove();
	var svg = d3.select('#frame').append('svg');

	set_screen_size();

	sys = new stc.System(svg, {
		sideView: '#view',
		actorsView: '.param_body.actor',
		nodesView: '.param_body.node'
	});

	refresh_options();
}

function set_screen_size() {
	var size = $('#screen_size').val();
	var svg = d3.select('#frame').select('svg');

	switch(size) {
		case 'fullscreen':
			svg.attr('width', 1000)
				.attr('height', 400);
			$('#param').css('height', 600);
			break;

		case 'debug':
			svg.attr('width', 800)
				.attr('height', 300);
			$('#param').css('height', 300);
			break;
	}
	if (sys) {
		sys.svgbox = {
			x: svg.attr('width'),
			y: svg.attr('height')
		};
	}
}

function refresh_options() {
	sys.options.report_elem = $('#stat').get(0);
	sys.options.callback.onObjectSelected = onObjectSelected;
	sys.options.callback.onObjectDeselected = onObjectDeselected;
	sys.options.nodeCapacity = 50;

	sys.options.duration = {
		addActor: 200,
		addNode: 200
	};
}

$('#screen_size').change(set_screen_size);


$('#start').click(function() {
	init();
});

$('#add_actor').click(function() {
	var actor_qty = $('#actor_qty').val();

	refresh_options();

	var thread = new Thread('main');
	thread.execute(function() {
		$('#add_actor').attr('disabled', 'disabled');
	});

	for (var i = 0; i < actor_qty; i++) {
		sys.addActor(thread, new stc.Actor('A' + actorIndex));
		actorCounter++;
		actorIndex++;
	}

	thread.execute(function() {
		$('#add_actor').attr('disabled', null);
	});

	thread.finish();
	thread.start();
});

$('#add_node').click(function() {
	var node_qty = $('#node_qty').val();

	refresh_options();

	var thread = new Thread('main');
	thread.execute(function() {
		$('#add_node').attr('disabled', 'disabled');
	});

	for (var i = 0; i < node_qty; i++) {
		sys.addNode(thread, new stc.Node('N' + nodeIndex, sys.selectedObject));
		nodeCounter++;
		nodeIndex++;
	}

	thread.execute(function() {
		$('#add_node').attr('disabled', null);
	});

	thread.finish();
	thread.start();
});

$('#rm_node').click(function() {
	refresh_options();
	var selectedNode = sys.selectedObject;

	var thread = new Thread('main');
	sys.unselectObject(thread, sys.selectedObject);
	sys.removeNode(thread, selectedNode);

	thread.finish();
	thread.start();
});

$('#next_cycle').click(function() {
	refresh_options();

	var thread = new Thread('main');
	stc.Utils.disableButton(thread, '#next_cycle');
	sys.nextCycle(thread);
	stc.Utils.enableButton(thread, '#next_cycle');

	thread.finish();
	thread.start();
});

$('#stop').click(function() {
	window.location.reload();
});

$('#scenario1').click(s1);
$('#scenario2').click(s2);

function s1() {
	init();

	var thread = new Thread('main');

	var actor_qty = 10;
	for (var i = 0; i < actor_qty; i++) {
		var actor = new stc.Actor('A' + actorIndex);
		sys.addActor(thread, actor);
		actorCounter++;
		actorIndex++;

		var node_qty = Math.randomizeInt(1, 5);
		for (var j = 0; j < node_qty; j++) {
			sys.addNode(thread, new stc.Node('N' + nodeIndex, actor));
			nodeCounter++;
			nodeIndex++;
		}
	}

	var cycle_qty = 10;
	for (var i = 0; i < cycle_qty; i++) {
		thread.sleep(500);
		sys.nextCycle(thread);
	}

	thread.finish();
	thread.start();
}

function s2() {
	init();

	var scenario = new stc.Scenario(sys);

	scenario.addProvider();

	var cycle_qty = 20;
	for (var i = 0; i < cycle_qty; i++) {

		// Remove some node(s).
		scenario.removeRandomNodes(0.5);

		// Add some provider(s).
		scenario.addRandomProviders(0, 3);

		// Add some node(s).
		scenario.addRandomNodes();

		scenario.nextCycle();
	}

	scenario.start();
}

$(document).ready(function() {
	$('.param_body').hide();
	$('.menu [data-body=settings]').click();
	set_screen_size();
});

$('.menu .button').click(function() {
	if ($(this).hasClass('disabled')) {
		return;
	}

	var body = $(this).attr('data-body');
	$('.param_body').hide();
	$('.menu .button').removeClass('selected');

	$(this).addClass('selected');
	$('.body .' + body).show();
});

function reset_stats() {
	$('#stat td').html(0);
};

$('#stat').get(0).addEventListener("system_stat", function(e) {
	var stats = e.detail;
	var el = $(this);
	//console.log(e);

	if (stats.actors != undefined) {
		el.find('.actors').html(stats.actors);
	}
	if (stats.nodes != undefined) {
		el.find('.nodes').html(stats.nodes);
	}
	if (stats.capacity != undefined) {
		el.find('.capacity').html(stats.capacity + ' GB');

		var stc = 0;
		if (sys.totalSTC) {
			stc = stats.capacity / sys.totalSTC;
		}
		el.find('.stc_gb').html(stc.toFixed(2) + ' GB');
	}
});
		</script>
	</body>
</html>